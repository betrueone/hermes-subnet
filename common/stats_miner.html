<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Challenge List</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; }
        .table thead th { background: #343a40; color: #fff; }
        .table tbody tr:hover { background: #e9ecef; }
        .container { margin-top: 40px; }
        .response-cell { max-width: 400px; white-space: pre-wrap; word-break: break-all; }
        .response-detail-pop {
            position: absolute;
            left: 0;
            right: 0;
            z-index: 10;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 16px;
            margin-bottom: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        .new-row-highlight {
            animation: pulseHighlight 1.5s infinite;
            border-left: 4px solid #ff9800;
        }
        @keyframes pulseHighlight {
            0% { background-color: #fff8e1; }
            50% { background-color: #ffecb3; }
            100% { background-color: #fff8e1; }
        }
        .status-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 5px 10px;
            border-radius: 4px;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .status-indicator.show {
            opacity: 1;
        }
        .error-row {
            background-color: #fff5f5;
        }
        .error-row:hover {
            background-color: #ffe8e8 !important;
        }
        .success-row {
            background-color: #f0fff4;
        }
        .success-row:hover {
            background-color: #e3f9e5 !important;
        }
        .tool-badge {
            display: inline-block;
            margin: 2px;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            background-color: #e9f5ff;
            color: #0366d6;
            border: 1px solid #cae3fc;
        }
        .request-container {
            display: flex;
            flex-direction: column;
        }
        .tool-container {
            display: flex;
            flex-wrap: wrap;
            margin-top: 4px;
            gap: 2px;
        }
        /* Statistics card style */
        .card {
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
        }
        .card-header {
            font-weight: 600;
        }
        .table-sm {
            font-size: 0.875rem;
        }
        .table-sm th, .table-sm td {
            padding: 0.5rem;
        }
        /* Statistics table footer style */
        .table tfoot tr {
            font-weight: bold;
        }
        /* Statistics area style */
        .stats-section {
            margin-bottom: 2rem;
        }
        /* Data update animation */
        @keyframes fadeUpdate {
            0% { background-color: rgba(25, 135, 84, 0.2); }
            100% { background-color: transparent; }
        }
        .updated-row {
            animation: fadeUpdate 2s ease;
        }
        /* Success/failure statistics style */
        .text-success {
            color: #198754 !important;
            font-weight: bold;
        }
        .text-danger {
            color: #dc3545 !important;
            font-weight: bold;
        }
        /* Project ID column style to handle long IDs */
        .project-id-cell {
            max-width: 200px;
            word-break: break-all;
            word-wrap: break-word;
            white-space: normal;
            overflow-wrap: break-word;
            hyphens: auto;
        }
    </style>
</head>
<body>
<div class="container">
    <h2 class="mb-4">Data Statistics</h2>
    
    <!-- Token Usage Statistics -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Token Usage Statistics</h5>
            <select id="token-time-range" class="form-select form-select-sm" style="width: auto;">
                <option value="30min">Last 30 minutes</option>
                <option value="1h" selected>Last 1 hour</option>
                <option value="2h">Last 2 hours</option>
                <option value="12h">Last 12 hours</option>
                <option value="24h">Last 24 hours</option>
            </select>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-sm table-striped">
                    <thead>
                        <tr>
                            <th rowspan="2" class="align-middle">Project ID</th>
                            <th colspan="3" class="text-center">Synthetic Challenge</th>
                            <th colspan="3" class="text-center">Organic Challenge</th>
                            <th rowspan="2" class="align-middle">Total Tokens</th>
                        </tr>
                        <tr>
                            <th>Input</th>
                            <th>Input Cache</th>
                            <th>Output</th>
                            <th>Input</th>
                            <th>Input Cache</th>
                            <th>Output</th>
                        </tr>
                    </thead>
                    <tbody id="token-usage-body">
                        <!-- Dynamically inserted data -->
                    </tbody>
                    <tfoot>
                        <tr class="table-info">
                            <td><strong>Total</strong></td>
                            <td id="total-synthetic-input">0</td>
                            <td id="total-synthetic-cache">0</td>
                            <td id="total-synthetic-output">0</td>
                            <td id="total-organic-input">0</td>
                            <td id="total-organic-cache">0</td>
                            <td id="total-organic-output">0</td>
                            <td id="total-all-tokens">0</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Tool Usage Statistics -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Tool Usage Statistics</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Synthetic tool usage statistics -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Synthetic Tool Usage</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Tool Name</th>
                                        <th>Usage Count</th>
                                    </tr>
                                </thead>
                                <tbody id="synthetic-tool-body">
                                    <!-- Dynamically inserted data -->
                                </tbody>
                                <tfoot>
                                    <tr class="table-primary">
                                        <td><strong>Total</strong></td>
                                        <td id="synthetic-tool-total">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Organic tool usage statistics -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Organic Tool Usage</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Tool Name</th>
                                        <th>Usage Count</th>
                                    </tr>
                                </thead>
                                <tbody id="organic-tool-body">
                                    <!-- Dynamically inserted data -->
                                </tbody>
                                <tfoot>
                                    <tr class="table-success">
                                        <td><strong>Total</strong></td>
                                        <td id="organic-tool-total">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Project Usage Statistics -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">Project Usage Statistics</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Synthetic project usage statistics -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Synthetic Project Usage</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Project ID</th>
                                        <th>Success</th>
                                        <th>Failure</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="synthetic-project-body">
                                    <!-- Dynamically inserted data -->
                                </tbody>
                                <tfoot>
                                    <tr class="table-primary">
                                        <td><strong>Total</strong></td>
                                        <td id="synthetic-project-success">0</td>
                                        <td id="synthetic-project-fail">0</td>
                                        <td id="synthetic-project-total">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Organic project usage statistics -->
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">Organic Project Usage</h6>
                        </div>
                        <div class="card-body">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Project ID</th>
                                        <th>Success</th>
                                        <th>Failure</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody id="organic-project-body">
                                    <!-- Dynamically inserted data -->
                                </tbody>
                                <tfoot>
                                    <tr class="table-success">
                                        <td><strong>Total</strong></td>
                                        <td id="organic-project-success">0</td>
                                        <td id="organic-project-fail">0</td>
                                        <td id="organic-project-total">0</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <h2 class="mb-4">Challenge List</h2>
    <div class="d-flex justify-content-between align-items-center mb-3">
        <span id="data-count" class="text-muted">0 records</span>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="auto-refresh" checked>
            <label class="form-check-label" for="auto-refresh">Auto Refresh (every 10s)</label>
        </div>
    </div>
    <table class="table table-bordered table-hover align-middle">
        <thead>
        <tr>
            <th>Type</th>
            <th>CID</th>
            <th>Request</th>
            <th>Cost</th>
            <th>Time</th>
        </tr>
        </thead>
        <tbody id="data-body">
        <!-- Data rows automatically inserted -->
        </tbody>
    </table>
</div>
<div id="status-indicator" class="status-indicator">Updating...</div>

<script>
// Helper function for rendering type
function renderType(type) {
    if (type === 0) return '<span class="badge bg-primary">Synthetic</span>';
    if (type === 1) return '<span class="badge bg-info">Organic</span>';
    if (type === 2) return '<span class="badge bg-success">Organic-S</span>';
    return type;
}

// DOM elements
const tbody = document.getElementById('data-body');
const dataCount = document.getElementById('data-count');
const autoRefreshToggle = document.getElementById('auto-refresh');
const statusIndicator = document.getElementById('status-indicator');
const tokenTimeRange = document.getElementById('token-time-range');
const tokenUsageBody = document.getElementById('token-usage-body');

// Status variables
let expandedIdx = null;
let detailPop = null;
let maxId = 0; // Track current maximum ID
let updateInProgress = false;
let rowIndex = 0; // Used to generate unique row indices
let rowMap = new Map(); // Store mapping between row IDs and DOM elements
let refreshTimer = null;
let tokenRefreshTimer = null; // Timer for token usage refresh

// Show status indicator
function showStatus(message, duration = 2000) {
    statusIndicator.textContent = message;
    statusIndicator.classList.add('show');
    setTimeout(() => {
        statusIndicator.classList.remove('show');
    }, duration);
}

// Token Usage Statistics Functions
async function loadTokenUsageData() {
    const timeRange = tokenTimeRange.value;
    try {
        const response = await fetch(`/stats/token_stats?latest=${timeRange}`);
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
        }
        const json = await response.json();
        updateTokenUsageTable(json.token_usage || []);
    } catch (error) {
        console.error('Failed to load token usage data:', error);
        tokenUsageBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">Failed to load token usage data: ${error.message}</td></tr>`;
    }
}

function updateTokenUsageTable(tokenData) {
    tokenUsageBody.innerHTML = '';
    
    // Aggregate data by cid_hash
    const aggregatedData = {};
    
    tokenData.forEach(item => {
        const cidHash = item.cid_hash;
        if (!aggregatedData[cidHash]) {
            aggregatedData[cidHash] = {
                synthetic_input: 0,
                synthetic_cache: 0,
                synthetic_output: 0,
                organic_input: 0,
                organic_cache: 0,
                organic_output: 0
            };
        }
        
        if (item.phase === 'miner_synthetic_challenge') {
            aggregatedData[cidHash].synthetic_input += item.input_tokens || 0;
            aggregatedData[cidHash].synthetic_cache += item.input_cache_read_tokens || 0;
            aggregatedData[cidHash].synthetic_output += item.output_tokens || 0;
        } else if (item.phase === 'miner_organic_challenge') {
            aggregatedData[cidHash].organic_input += item.input_tokens || 0;
            aggregatedData[cidHash].organic_cache += item.input_cache_read_tokens || 0;
            aggregatedData[cidHash].organic_output += item.output_tokens || 0;
        }
    });
    
    // Calculate totals
    let totalSyntheticInput = 0;
    let totalSyntheticCache = 0;
    let totalSyntheticOutput = 0;
    let totalOrganicInput = 0;
    let totalOrganicCache = 0;
    let totalOrganicOutput = 0;
    
    // Create table rows
    Object.entries(aggregatedData).forEach(([cidHash, data]) => {
        const tr = document.createElement('tr');
        // Calculate effective total: (input - cache + output) for both synthetic and organic
        const effectiveTotal = (data.synthetic_input - data.synthetic_cache + data.synthetic_output) + 
                               (data.organic_input - data.organic_cache + data.organic_output);
        
        tr.innerHTML = `
            <td class="project-id-cell">${cidHash}</td>
            <td>${data.synthetic_input.toLocaleString()}</td>
            <td>${data.synthetic_cache.toLocaleString()}</td>
            <td>${data.synthetic_output.toLocaleString()}</td>
            <td>${data.organic_input.toLocaleString()}</td>
            <td>${data.organic_cache.toLocaleString()}</td>
            <td>${data.organic_output.toLocaleString()}</td>
            <td><strong>${effectiveTotal.toLocaleString()}</strong></td>
        `;
        tokenUsageBody.appendChild(tr);
        
        // Update totals
        totalSyntheticInput += data.synthetic_input;
        totalSyntheticCache += data.synthetic_cache;
        totalSyntheticOutput += data.synthetic_output;
        totalOrganicInput += data.organic_input;
        totalOrganicCache += data.organic_cache;
        totalOrganicOutput += data.organic_output;
    });
    
    // Calculate effective total for footer
    const effectiveTotal = (totalSyntheticInput - totalSyntheticCache + totalSyntheticOutput) + 
                          (totalOrganicInput - totalOrganicCache + totalOrganicOutput);
    
    // Update total row
    document.getElementById('total-synthetic-input').textContent = totalSyntheticInput.toLocaleString();
    document.getElementById('total-synthetic-cache').textContent = totalSyntheticCache.toLocaleString();
    document.getElementById('total-synthetic-output').textContent = totalSyntheticOutput.toLocaleString();
    document.getElementById('total-organic-input').textContent = totalOrganicInput.toLocaleString();
    document.getElementById('total-organic-cache').textContent = totalOrganicCache.toLocaleString();
    document.getElementById('total-organic-output').textContent = totalOrganicOutput.toLocaleString();
    document.getElementById('total-all-tokens').textContent = effectiveTotal.toLocaleString();
    
    // Show no data message if empty
    if (Object.keys(aggregatedData).length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="8" class="text-center text-muted">No token usage data available</td>`;
        tokenUsageBody.appendChild(tr);
    }
}

    // Create row element
function createRow(row) {
    const tr = document.createElement('tr');
    tr.dataset.id = row[0];
    tr.dataset.idx = rowIndex++;
    
    // Check status code and add different styles accordingly
    const statusCode = row[8]; // Status code field (index updated)
    // Convert to string for comparison
    if (statusCode && String(statusCode) !== '200') {
        tr.classList.add('error-row');
    } else {
        tr.classList.add('success-row');
    }
    
    // Process tool hit information
    let toolHitHtml = '';
    try {
        const toolHit = JSON.parse(row[9] || '[]');
        if (Array.isArray(toolHit) && toolHit.length > 0) {
            toolHitHtml = '<div class="tool-container">';
            toolHit.forEach(([tool, count]) => {
                toolHitHtml += `<span class="tool-badge">${tool}: ${count}</span>`;
            });
            toolHitHtml += '</div>';
        }
    } catch (e) {
        console.error('Failed to parse tool_hit:', e);
    }
    
    // Format cost value (now the 10th field)
    const cost = typeof row[10] === 'number' ? row[10].toFixed(2) : parseFloat(row[10] || 0).toFixed(2);
    
    let typeHtml = renderType(row[1]);
    if ((row[1] === 0 || row[1] === 1 || row[1] === 2) && String(statusCode) !== '200') {
        // Synthetic or Organic or Organic-S and non-200, set to red
        if (row[1] === 0) {
            typeHtml = '<span class="badge bg-danger">Synthetic</span>';
        } else if (row[1] === 1) {
            typeHtml = '<span class="badge bg-danger">Organic</span>';
        } else if (row[1] === 2) {
            typeHtml = '<span class="badge bg-danger">Organic-S</span>';
        }
    }
    tr.innerHTML = `
        <td>${typeHtml}</td>
        <td>${row[5] || ''}</td>
        <td>
            <div class="request-container">
                <div>${row[6] || ''}</div>
                ${toolHitHtml}
            </div>
        </td>
        <td>${cost}</td>
        <td>${row[12] || ''}</td>
    `;
    
    // Click to expand details and remove highlight
    tr.addEventListener('click', () => {
        // Remove highlight effect
        if (tr.classList.contains('new-row-highlight')) {
            tr.classList.remove('new-row-highlight');
        }
        
        const currentIdx = tr.dataset.idx;
        if (expandedIdx === currentIdx) {
            if (detailPop) {
                detailPop.remove();
                detailPop = null;
            }
            expandedIdx = null;
        } else {
            if (detailPop) {
                detailPop.remove();
                detailPop = null;
            }
            detailPop = document.createElement('div');
            detailPop.className = 'response-detail-pop';
            // Status code information
            const statusCode = row[8];
            const statusStyle = String(statusCode) !== '200' ? 'color: #dc3545;' : 'color: #28a745;';

            // Parse token usage info
            let tokenUsageHtml = '';
            const tokenUsageInfo = row[11]; // token_usage_info is the 12th field (index 11)
            if (tokenUsageInfo && tokenUsageInfo !== '') {
                try {
                    const tokenData = JSON.parse(tokenUsageInfo);
                    const inputTokens = tokenData.input_tokens || 0;
                    const inputCacheTokens = tokenData.input_cache_read_tokens || 0;
                    const outputTokens = tokenData.output_tokens || 0;
                    const effectiveTotal = inputTokens - inputCacheTokens + outputTokens;
                    
                    tokenUsageHtml = `
                        <b>Token Usage:</b><br>
                        &nbsp;&nbsp;Input Tokens: <span style="color: #0066cc; font-weight: bold;">${inputTokens}</span><br>
                        &nbsp;&nbsp;Input Cache: <span style="color: #6c757d; font-weight: bold;">${inputCacheTokens}</span><br>
                        &nbsp;&nbsp;Output Tokens: <span style="color: #cc6600; font-weight: bold;">${outputTokens}</span><br>
                        &nbsp;&nbsp;Effective Total: <span style="color: #006600; font-weight: bold;">${effectiveTotal}</span><br><hr>
                    `;
                } catch (e) {
                    console.error('Failed to parse token usage info:', e);
                    tokenUsageHtml = '<b>Token Usage:</b> Invalid data<br><hr>';
                }
            }

            detailPop.innerHTML = `
                <b>Response:</b><br><pre style='max-height:300px;overflow:auto;'>${row[7] || ''}</pre><hr>
                ${tokenUsageHtml}
                <b>ID:</b> ${row[0]}<br>
                <b>Type:</b> ${renderType(row[1])}<br>
                <b>Source:</b> ${row[2] || ''}<br>
                <b>Task ID:</b> ${row[3] || ''}<br>
                <b>Project ID:</b> ${row[4] || ''}<br>
                <b>Status Code:</b> <span style="${statusStyle}">${statusCode || 200}</span><br>
                <b>Time:</b> ${row[12] || ''}
            `;
            
            // Calculate insertion position
            const rect = tr.getBoundingClientRect();
            detailPop.style.top = (window.scrollY + rect.bottom) + 'px';
            detailPop.style.left = rect.left + 'px';
            detailPop.style.width = rect.width + 'px';
            document.body.appendChild(detailPop);
            expandedIdx = currentIdx;
        }
    });
    
    return tr;
}

// Initial data loading
// Store previous statistics data
let prevStats = {
    synthetic_tool_usage: {},
    organic_tool_usage: {},
    synthetic_project_usage: {},
    organic_project_usage: {}
};

// Update tool usage statistics table
function updateToolUsageTable(data, tableId, totalId) {
    const tableBody = document.getElementById(tableId);
    const totalElement = document.getElementById(totalId);
    
    if (!tableBody || !totalElement) return;
    
    // Get table type identifier
    const tableType = tableId.includes('synthetic') ? 'synthetic_tool_usage' : 'organic_tool_usage';
    const prevData = prevStats[tableType] || {};
    
    tableBody.innerHTML = '';
    let total = 0;
    
    // Sort data by usage count in descending order
    const sortedData = Object.entries(data).sort((a, b) => b[1] - a[1]);
    
    sortedData.forEach(([name, count]) => {
        const tr = document.createElement('tr');
        
        // Check if data has changed
        const prevCount = prevData[name] || 0;
        if (count !== prevCount) {
            tr.classList.add('updated-row');
        }
        
        tr.innerHTML = `
            <td>${name}</td>
            <td>${count}</td>
        `;
        tableBody.appendChild(tr);
        total += count;
    });
    
    // If no data, show message
    if (sortedData.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="2" class="text-center text-muted">No data available</td>`;
        tableBody.appendChild(tr);
    }
    
    // Update total and check for changes
    const prevTotal = Object.values(prevData).reduce((sum, curr) => sum + curr, 0);
    totalElement.textContent = total;
    if (total !== prevTotal) {
        totalElement.parentElement.classList.add('updated-row');
        setTimeout(() => {
            totalElement.parentElement.classList.remove('updated-row');
        }, 2000);
    }
    
    // Update stored data
    prevStats[tableType] = {...data};
}

// Update project usage statistics table
function updateProjectUsageTable(data, tableId, totalId) {
    const tableBody = document.getElementById(tableId);
    const totalElement = document.getElementById(totalId);
    const tableType = tableId.includes('synthetic') ? 'synthetic' : 'organic';
    
    // Get elements for success and failure counts
    const successElement = document.getElementById(`${tableType}-project-success`);
    const failElement = document.getElementById(`${tableType}-project-fail`);
    
    if (!tableBody || !totalElement || !successElement || !failElement) return;
    
    // Get table type identifier
    const statsType = `${tableType}_project_usage`;
    const prevData = prevStats[statsType] || {};
    
    tableBody.innerHTML = '';
    let totalSuccess = 0;
    let totalFail = 0;
    
    // Sort data by total usage count in descending order (success + failure)
    const sortedData = Object.entries(data).sort((a, b) => {
        const totalA = a[1][0] + a[1][1]; // success + failure
        const totalB = b[1][0] + b[1][1]; // success + failure
        return totalB - totalA;
    });
    
    sortedData.forEach(([projectId, counts]) => {
        const tr = document.createElement('tr');
        
        // Parse success and failure counts
        const successCount = counts[0] || 0;
        const failCount = counts[1] || 0;
        const totalCount = successCount + failCount;
        
        // Check if data has changed
        const prevCounts = prevData[projectId] || [0, 0];
        const hasChanged = prevCounts[0] !== successCount || prevCounts[1] !== failCount;
        if (hasChanged) {
            tr.classList.add('updated-row');
        }
        
        tr.innerHTML = `
            <td class="project-id-cell">${projectId}</td>
            <td><span class="text-success">${successCount}</span></td>
            <td><span class="text-danger">${failCount}</span></td>
            <td>${totalCount}</td>
        `;
        tableBody.appendChild(tr);
        
        totalSuccess += successCount;
        totalFail += failCount;
    });
    
    // If no data, show message
    if (sortedData.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="4" class="text-center text-muted">No data available</td>`;
        tableBody.appendChild(tr);
    }
    
    // Calculate total
    const total = totalSuccess + totalFail;
    
    // Update all totals and check for changes
    let hasChanged = false;
    
    // Calculate previous totals
    let prevTotalSuccess = 0;
    let prevTotalFail = 0;
    Object.values(prevData).forEach(counts => {
        prevTotalSuccess += counts[0] || 0;
        prevTotalFail += counts[1] || 0;
    });
    const prevTotal = prevTotalSuccess + prevTotalFail;
    
    // Check if each total has changed
    if (prevTotalSuccess !== totalSuccess) {
        hasChanged = true;
        successElement.textContent = totalSuccess;
    } else {
        successElement.textContent = totalSuccess;
    }
    
    if (prevTotalFail !== totalFail) {
        hasChanged = true;
        failElement.textContent = totalFail;
    } else {
        failElement.textContent = totalFail;
    }
    
    if (prevTotal !== total) {
        hasChanged = true;
        totalElement.textContent = total;
    } else {
        totalElement.textContent = total;
    }
    
    // If there are any changes, add highlight animation
    if (hasChanged) {
        const footerRow = totalElement.parentElement;
        footerRow.classList.add('updated-row');
        setTimeout(() => {
            footerRow.classList.remove('updated-row');
        }, 2000);
    }
    
    // Update stored data
    prevStats[statsType] = {};
    for (const [key, value] of Object.entries(data)) {
        prevStats[statsType][key] = [...value]; // Copy array
    }
}

// Update all statistics tables
function updateAllUsageTables(usageData) {
    if (!usageData) return;
    
    // Update tool usage statistics
    updateToolUsageTable(usageData.synthetic_tool_usage || {}, 'synthetic-tool-body', 'synthetic-tool-total');
    updateToolUsageTable(usageData.organic_tool_usage || {}, 'organic-tool-body', 'organic-tool-total');
    
    // Update project usage statistics
    updateProjectUsageTable(usageData.synthetic_project_usage || {}, 'synthetic-project-body', 'synthetic-project-total');
    updateProjectUsageTable(usageData.organic_project_usage || {}, 'organic-project-body', 'organic-project-total');
}

function loadInitialData() {
    showStatus('Loading data...');
    fetch('/stats/data')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
            }
            return response.json();
        })
        .then(json => {
            const data = json.data || [];
            tbody.innerHTML = '';
            expandedIdx = null;
            if (detailPop) {
                detailPop.remove();
                detailPop = null;
            }
            rowMap.clear();
            
            // Record maximum ID
            if (data.length > 0) {
                data.forEach(row => {
                    if (row[0] > maxId) maxId = row[0];
                });
            }
            
            // Render all rows
            data.forEach(row => {
                const tr = createRow(row);
                tbody.appendChild(tr);
                rowMap.set(row[0], tr);
            });
            
            // Update usage statistics tables
            if (json.usage) {
                updateAllUsageTables(json.usage);
            }
            
            // Load token usage data
            loadTokenUsageData();
            
            dataCount.textContent = `${data.length} records`;
            showStatus(`Loading successful, ${data.length} records`);
        })
        .catch(error => {
            console.error('Data loading failed:', error);
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">Data loading failed: ${error.message}</td></tr>`;
            showStatus('Loading failed', 3000);
        });
}

// Incrementally fetch new data
function fetchNewData() {
    if (updateInProgress) return;
    updateInProgress = true;
    
    fetch(`/stats/data?since_id=${maxId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
            }
            return response.json();
        })
        .then(json => {
            const newData = json.data || [];
            
            // Update usage statistics tables regardless of new data
            if (json.usage) {
                updateAllUsageTables(json.usage);
            }
            
            // Also refresh token usage data
            loadTokenUsageData();
            
            if (newData.length > 0) {
                let newMaxId = maxId;
                
                // Sort by ID in descending order to ensure newest records show first
                const sortedData = [...newData].sort((a, b) => b[0] - a[0]);
                
                // Insert new rows at the top of the table
                sortedData.forEach(row => {
                    // Check if row already exists
                    if (!rowMap.has(row[0])) {
                        const tr = createRow(row);
                        tr.classList.add('new-row-highlight');
                        tbody.insertBefore(tr, tbody.firstChild);
                        rowMap.set(row[0], tr);
                        
                        if (row[0] > newMaxId) newMaxId = row[0];
                    }
                });
                
                // Update maximum ID
                maxId = newMaxId;
                
                // Update count
                const totalCount = rowMap.size;
                dataCount.textContent = `${totalCount} records`;
                
                showStatus(`Added ${newData.length} new records`);
            }
        })
        .catch(error => {
            console.error('Failed to fetch new data:', error);
            showStatus('Update failed', 3000);
        })
        .finally(() => {
            updateInProgress = false;
        });
}

// Control auto refresh
function toggleAutoRefresh() {
    if (autoRefreshToggle.checked) {
        refreshTimer = setInterval(fetchNewData, 10000);
        // Also refresh token usage data every 30 seconds
        tokenRefreshTimer = setInterval(loadTokenUsageData, 30000);
        showStatus('Auto refresh enabled');
    } else {
        if (refreshTimer) {
            clearInterval(refreshTimer);
            refreshTimer = null;
        }
        if (tokenRefreshTimer) {
            clearInterval(tokenRefreshTimer);
            tokenRefreshTimer = null;
        }
        showStatus('Auto refresh disabled');
    }
}

// Initialize
loadInitialData();
loadTokenUsageData(); // Load initial token usage data
autoRefreshToggle.addEventListener('change', toggleAutoRefresh);
tokenTimeRange.addEventListener('change', loadTokenUsageData); // Update when time range changes
toggleAutoRefresh(); // Initial setting

// Check if data is loaded
setTimeout(() => {
    if (tbody.children.length === 0) {
        tbody.innerHTML = '';
    }
}, 3000);
</script>
</body>
</html>
